<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rubavu Buildings â€” Live Dashboard</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap');

:root {
  --bg: #080f1a;
  --bg2: #0c1622;
  --bg3: #101e2e;
  --card: #0e1e30;
  --card-h: #152840;
  --border: #1a3045;
  --border-h: #234566;
  --cyan: #00d4ff;
  --cyan2: #0099cc;
  --green: #00e676;
  --orange: #ff9100;
  --red: #ff4444;
  --yellow: #ffe600;
  --purple: #b388ff;
  --text: #e8f0f7;
  --text2: #6b8fa8;
  --text3: #2e4a60;
  --mono: 'JetBrains Mono', monospace;
  --sans: 'Space Grotesk', sans-serif;
}

* { margin:0; padding:0; box-sizing:border-box; }

html { scroll-behavior: smooth; }

body {
  font-family: var(--sans);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* â”€â”€â”€ BACKGROUND â”€â”€â”€ */
.bg-mesh {
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 60% 40% at 15% 30%, rgba(0,212,255,0.04) 0%, transparent 60%),
    radial-gradient(ellipse 40% 60% at 85% 70%, rgba(0,230,118,0.03) 0%, transparent 60%),
    radial-gradient(ellipse 50% 50% at 50% 100%, rgba(179,136,255,0.02) 0%, transparent 60%);
}

.grid-overlay {
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background-image:
    linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px);
  background-size: 40px 40px;
}

/* â”€â”€â”€ LAYOUT â”€â”€â”€ */
.wrap {
  position: relative; z-index: 1;
  max-width: 1400px;
  margin: 0 auto;
  padding: 28px 32px 60px;
}

/* â”€â”€â”€ HEADER â”€â”€â”€ */
.header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 32px;
  flex-wrap: wrap;
  gap: 16px;
}

.header-left {}

.live-pill {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 5px 14px;
  background: rgba(0,230,118,0.08);
  border: 1px solid rgba(0,230,118,0.25);
  border-radius: 100px;
  font-size: 11px;
  font-weight: 600;
  color: var(--green);
  letter-spacing: 0.5px;
  text-transform: uppercase;
  margin-bottom: 12px;
}

.live-dot {
  width: 7px; height: 7px;
  background: var(--green);
  border-radius: 50%;
  animation: livePulse 2s infinite;
}

@keyframes livePulse {
  0%,100% { opacity:1; box-shadow: 0 0 0 0 rgba(0,230,118,0.4); }
  50% { opacity:0.7; box-shadow: 0 0 0 5px rgba(0,230,118,0); }
}

.page-title {
  font-size: clamp(22px, 3vw, 34px);
  font-weight: 700;
  letter-spacing: -0.5px;
  line-height: 1.1;
  color: var(--text);
}

.page-title span {
  background: linear-gradient(135deg, var(--cyan) 0%, #5555ff 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.page-sub {
  font-size: 13px;
  color: var(--text2);
  margin-top: 6px;
  line-height: 1.6;
}

.header-right {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 8px;
}

.last-updated {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text3);
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 6px 12px;
}

.last-updated span { color: var(--cyan); }

.refresh-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 7px 14px;
  background: rgba(0,212,255,0.08);
  border: 1px solid rgba(0,212,255,0.2);
  border-radius: 7px;
  color: var(--cyan);
  font-family: var(--sans);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.refresh-btn:hover {
  background: rgba(0,212,255,0.15);
  border-color: rgba(0,212,255,0.4);
  transform: translateY(-1px);
}

.refresh-btn svg { width:14px; height:14px; transition: transform 0.5s; }
.refresh-btn.spinning svg { animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€â”€ LOADING / ERROR â”€â”€â”€ */
.state-overlay {
  display: none;
  position: fixed; inset:0; z-index: 100;
  background: rgba(8,15,26,0.92);
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 16px;
}

.state-overlay.visible { display: flex; }

.loader-ring {
  width: 48px; height: 48px;
  border: 3px solid var(--border);
  border-top-color: var(--cyan);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

.state-text {
  font-size: 14px;
  color: var(--text2);
}

.error-box {
  background: rgba(255,68,68,0.1);
  border: 1px solid rgba(255,68,68,0.3);
  border-radius: 10px;
  padding: 20px 28px;
  text-align: center;
  max-width: 420px;
}

.error-box h3 { color: var(--red); margin-bottom: 8px; font-size: 15px; }
.error-box p { font-size: 12px; color: var(--text2); line-height: 1.6; }

.retry-btn {
  margin-top: 14px;
  padding: 8px 20px;
  background: rgba(255,68,68,0.15);
  border: 1px solid rgba(255,68,68,0.3);
  border-radius: 6px;
  color: var(--red);
  font-family: var(--sans);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.retry-btn:hover { background: rgba(255,68,68,0.25); }

/* â”€â”€â”€ AUTH PANEL â”€â”€â”€ */
.auth-panel {
  display: none;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px 24px;
  margin-bottom: 24px;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
}

.auth-panel.visible { display: flex; }
.auth-label { font-size: 13px; color: var(--text2); white-space: nowrap; }

.auth-input {
  flex: 1;
  min-width: 200px;
  padding: 9px 14px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 7px;
  color: var(--text);
  font-family: var(--mono);
  font-size: 12px;
  outline: none;
  transition: border-color 0.2s;
}

.auth-input:focus { border-color: var(--cyan); }

.auth-btn {
  padding: 9px 20px;
  background: var(--cyan);
  border: none;
  border-radius: 7px;
  color: #080f1a;
  font-family: var(--sans);
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.auth-btn:hover { background: #33ddff; transform: translateY(-1px); }

/* â”€â”€â”€ SECTION LABEL â”€â”€â”€ */
.section-label {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 14px;
  margin-top: 28px;
}

.section-label:first-of-type { margin-top: 0; }

.section-title {
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text2);
  display: flex;
  align-items: center;
  gap: 10px;
}

.section-title::before {
  content: '';
  width: 3px; height: 16px;
  background: var(--cyan);
  border-radius: 2px;
}

.section-meta { font-size: 11px; color: var(--text3); font-family: var(--mono); }

/* â”€â”€â”€ KPI GRID â”€â”€â”€ */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 12px;
  margin-bottom: 4px;
}

.kpi-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 18px 16px 14px;
  position: relative;
  overflow: hidden;
  transition: all 0.3s;
}

.kpi-card::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: var(--kpi-color);
}

.kpi-card:hover {
  border-color: var(--kpi-color);
  background: var(--card-h);
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(0,0,0,0.35);
}

.kpi-card.cyan  { --kpi-color: var(--cyan); }
.kpi-card.green { --kpi-color: var(--green); }
.kpi-card.red   { --kpi-color: var(--red); }
.kpi-card.yellow{ --kpi-color: var(--yellow); }
.kpi-card.purple{ --kpi-color: var(--purple); }

.kpi-icon {
  width: 30px; height: 30px;
  border-radius: 8px;
  background: rgba(255,255,255,0.04);
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 12px;
  font-size: 15px;
}

.kpi-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  color: var(--text2);
  margin-bottom: 6px;
}

.kpi-value {
  font-family: var(--mono);
  font-size: 26px;
  font-weight: 700;
  color: var(--kpi-color);
  line-height: 1;
  transition: all 0.4s;
}

.kpi-sub {
  font-size: 10px;
  color: var(--text3);
  margin-top: 5px;
}

.kpi-badge {
  position: absolute;
  top: 14px; right: 14px;
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 700;
  padding: 3px 8px;
  border-radius: 4px;
  background: rgba(255,255,255,0.05);
  color: var(--text2);
}

/* â”€â”€â”€ TWO-COL CHARTS â”€â”€â”€ */
.charts-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 4px;
}

.chart-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  transition: border-color 0.3s;
}

.chart-card.full { grid-column: 1 / -1; }

.chart-head {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 18px;
}

.chart-name {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
}

.chart-desc { font-size: 11px; color: var(--text2); margin-top: 3px; }

.chart-total-val {
  font-family: var(--mono);
  font-size: 18px;
  font-weight: 700;
  color: var(--red);
  text-align: right;
}

.chart-total-lbl { font-size: 10px; color: var(--text3); text-align: right; text-transform: uppercase; }

/* â”€â”€â”€ BAR ROWS â”€â”€â”€ */
.bar-list { display: flex; flex-direction: column; gap: 8px; }

.bar-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 5px;
  margin: -5px;
  border-radius: 8px;
  cursor: default;
  transition: background 0.2s;
}

.bar-row:hover { background: rgba(0,212,255,0.04); }

.bar-label {
  width: 70px;
  font-size: 11px;
  color: var(--text2);
  text-align: right;
  flex-shrink: 0;
  font-family: var(--mono);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.bar-track {
  flex: 1;
  height: 26px;
  background: var(--bg3);
  border-radius: 5px;
  overflow: hidden;
}

.bar-fill {
  height: 100%;
  border-radius: 5px;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-right: 8px;
  transition: width 0.6s cubic-bezier(0.4,0,0.2,1);
  min-width: 50px;
}

.bar-val {
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 700;
  color: rgba(0,0,0,0.75);
}

.bar-pct {
  width: 38px;
  text-align: right;
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text3);
  flex-shrink: 0;
}

/* â”€â”€â”€ ZONING TABLE â”€â”€â”€ */
.zone-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}

.zone-table thead th {
  padding: 8px 12px;
  text-align: left;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text3);
  border-bottom: 1px solid var(--border);
  font-weight: 600;
}

.zone-table thead th:last-child,
.zone-table thead th:nth-child(3) { text-align: right; }

.zone-table tbody tr {
  border-bottom: 1px solid rgba(26,48,69,0.5);
  transition: background 0.15s;
}

.zone-table tbody tr:hover { background: rgba(0,212,255,0.03); }
.zone-table tbody tr:last-child { border-bottom: none; }

.zone-table tbody td {
  padding: 9px 12px;
  color: var(--text2);
  vertical-align: middle;
}

.zone-table tbody td:last-child,
.zone-table tbody td:nth-child(3) {
  text-align: right;
  font-family: var(--mono);
  font-size: 11px;
}

.zone-chip {
  display: inline-block;
  padding: 3px 9px;
  border-radius: 4px;
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 700;
  color: #0d1520;
}

.zone-name { color: var(--text); font-size: 11px; }
.zone-province { font-size: 10px; color: var(--text3); }

.mini-bar-wrap {
  display: flex;
  align-items: center;
  gap: 8px;
}

.mini-bar {
  flex: 1;
  height: 6px;
  background: var(--bg3);
  border-radius: 3px;
  overflow: hidden;
}

.mini-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.5s ease;
}

.rank-badge {
  width: 22px; height: 22px;
  border-radius: 50%;
  background: var(--bg3);
  border: 1px solid var(--border);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text3);
}

.rank-badge.top { border-color: var(--red); color: var(--red); background: rgba(255,68,68,0.08); }

/* â”€â”€â”€ COMPLIANCE DONUT â”€â”€â”€ */
.donut-wrap {
  display: flex;
  align-items: center;
  gap: 28px;
}

.donut-svg { flex-shrink: 0; }
.donut-legend { display: flex; flex-direction: column; gap: 10px; }

.donut-leg-item {
  display: flex;
  align-items: center;
  gap: 10px;
}

.donut-leg-dot {
  width: 10px; height: 10px;
  border-radius: 3px;
  flex-shrink: 0;
}

.donut-leg-label { font-size: 12px; color: var(--text2); }

.donut-leg-val {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 700;
  color: var(--text);
  margin-left: auto;
}

/* â”€â”€â”€ SECTOR BREAKDOWN â”€â”€â”€ */
.sector-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 10px;
}

.sector-item {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px 14px;
  transition: all 0.2s;
}

.sector-item:hover {
  border-color: var(--border-h);
  background: var(--card-h);
}

.sector-name {
  font-size: 12px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 6px;
}

.sector-stats {
  display: flex;
  gap: 12px;
}

.sector-stat { }

.sector-stat-val {
  font-family: var(--mono);
  font-size: 14px;
  font-weight: 700;
  color: var(--red);
}

.sector-stat-lbl { font-size: 9px; color: var(--text3); text-transform: uppercase; }

/* â”€â”€â”€ FOOTER â”€â”€â”€ */
.footer {
  margin-top: 40px;
  padding-top: 20px;
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 12px;
}

.footer-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.footer-logo {
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 700;
  color: var(--cyan);
  background: rgba(0,212,255,0.08);
  border: 1px solid rgba(0,212,255,0.2);
  padding: 4px 10px;
  border-radius: 5px;
}

.footer-text { font-size: 11px; color: var(--text3); }
.footer-right { font-size: 11px; color: var(--text3); font-family: var(--mono); }

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
@media (max-width: 1100px) {
  .kpi-grid { grid-template-columns: repeat(3, 1fr); }
}

@media (max-width: 800px) {
  .wrap { padding: 18px 16px 40px; }
  .kpi-grid { grid-template-columns: repeat(2, 1fr); }
  .charts-row { grid-template-columns: 1fr; }
  .charts-row .chart-card.full { grid-column: 1; }
  .donut-wrap { flex-direction: column; align-items: flex-start; }
  .header { flex-direction: column; }
  .header-right { align-items: flex-start; }
}

@media (max-width: 500px) {
  .kpi-grid { grid-template-columns: 1fr 1fr; }
  .zone-table { font-size: 11px; }
}

/* â”€â”€â”€ SKELETON â”€â”€â”€ */
.skeleton {
  background: linear-gradient(90deg, var(--bg3) 25%, var(--card) 50%, var(--bg3) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: 4px;
  color: transparent !important;
}

@keyframes shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
</style>
</head>
<body>

<div class="bg-mesh"></div>
<div class="grid-overlay"></div>

<!-- Loading overlay -->
<div class="state-overlay" id="loadingOverlay">
  <div class="loader-ring"></div>
  <div class="state-text">Querying feature layerâ€¦</div>
</div>

<!-- Error overlay -->
<div class="state-overlay" id="errorOverlay">
  <div class="error-box">
    <h3>âš  Unable to reach feature layer</h3>
    <p id="errorMsg">The service may require authentication or is currently unavailable.</p>
    <button class="retry-btn" onclick="retryLoad()">â†º Retry</button>
  </div>
</div>

<div class="wrap">

  <!-- HEADER -->
  <header class="header">
    <div class="header-left">
      <div class="live-pill">
        <span class="live-dot"></span>
        Live â€” ArcGIS Enterprise
      </div>
      <h1 class="page-title">Rubavu <span>Buildings</span> Dashboard</h1>
      <p class="page-sub">Real-time construction compliance analysis Â· Western Province Â· Rubavu District</p>
    </div>
    <div class="header-right">
      <div class="last-updated">Updated <span id="lastUpdated">â€”</span></div>
      <button class="refresh-btn" id="refreshBtn" onclick="loadAll()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M23 4v6h-6M1 20v-6h6"/>
          <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
        </svg>
        Refresh
      </button>
    </div>
  </header>

  <!-- AUTH PANEL â€” shown if token needed -->
  <div class="auth-panel" id="authPanel">
    <span class="auth-label">ğŸ” Enterprise login required:</span>
    <input class="auth-input" type="text"     id="userInput"  placeholder="Username" style="max-width:160px"/>
    <input class="auth-input" type="password" id="passInput"  placeholder="Password" style="max-width:160px"/>
    <button class="auth-btn" onclick="loginWithCredentials()">Sign In</button>
    <span style="color:var(--text3);font-size:11px;margin:0 4px">or</span>
    <input class="auth-input" type="password" id="tokenInput" placeholder="Paste token directlyâ€¦" />
    <button class="auth-btn" style="background:var(--border-h);color:var(--text)" onclick="applyToken()">Use Token</button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION 1 â€” KPI OVERVIEW
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="section-label">
    <span class="section-title">Overview</span>
    <span class="section-meta" id="totalBuildingsNote">â€”</span>
  </div>

  <div class="kpi-grid">
    <div class="kpi-card cyan">
      <div class="kpi-icon">ğŸ—</div>
      <div class="kpi-label">Total Buildings</div>
      <div class="kpi-value" id="kpiTotal">â€”</div>
      <div class="kpi-sub">Detected in Rubavu</div>
    </div>
    <div class="kpi-card green">
      <div class="kpi-icon">âœ…</div>
      <div class="kpi-label">Legal</div>
      <div class="kpi-value" id="kpiLegal">â€”</div>
      <div class="kpi-sub">Permit verified</div>
      <div class="kpi-badge" id="kpiLegalPct">â€”</div>
    </div>
    <div class="kpi-card red">
      <div class="kpi-icon">ğŸš«</div>
      <div class="kpi-label">Illegal</div>
      <div class="kpi-value" id="kpiIllegal">â€”</div>
      <div class="kpi-sub">Violations detected</div>
      <div class="kpi-badge" id="kpiIllegalPct">â€”</div>
    </div>
    <div class="kpi-card yellow">
      <div class="kpi-icon">â³</div>
      <div class="kpi-label">Existing / Unknown</div>
      <div class="kpi-value" id="kpiExisting">â€”</div>
      <div class="kpi-sub">Pending verification</div>
      <div class="kpi-badge" id="kpiExistingPct">â€”</div>
    </div>
    <div class="kpi-card purple">
      <div class="kpi-icon">ğŸ“Š</div>
      <div class="kpi-label">Compliance Rate</div>
      <div class="kpi-value" id="kpiCompliance">â€”</div>
      <div class="kpi-sub" id="kpiComplianceSub">of verified buildings</div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION 2 â€” STATUS BREAKDOWN + DONUT
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="section-label" style="margin-top:32px;">
    <span class="section-title">Legal Status Breakdown</span>
    <span class="section-meta">Verified vs unverified buildings</span>
  </div>

  <div class="charts-row">

    <!-- Compliance donut -->
    <div class="chart-card">
      <div class="chart-head">
        <div>
          <div class="chart-name">Compliance Overview</div>
          <div class="chart-desc">Legal vs Illegal vs Existing</div>
        </div>
      </div>
      <div class="donut-wrap">
        <svg class="donut-svg" width="140" height="140" viewBox="0 0 140 140" id="donutSvg">
          <circle cx="70" cy="70" r="54" fill="none" stroke="#101e2e" stroke-width="22"/>
          <!-- Segments drawn by JS -->
        </svg>
        <div class="donut-legend" id="donutLegend">
          <div class="donut-leg-item">
            <div class="donut-leg-dot" style="background:var(--green)"></div>
            <span class="donut-leg-label">Legal</span>
            <span class="donut-leg-val" id="legLegal">â€”</span>
          </div>
          <div class="donut-leg-item">
            <div class="donut-leg-dot" style="background:var(--red)"></div>
            <span class="donut-leg-label">Illegal</span>
            <span class="donut-leg-val" id="legIllegal">â€”</span>
          </div>
          <div class="donut-leg-item">
            <div class="donut-leg-dot" style="background:var(--yellow)"></div>
            <span class="donut-leg-label">Existing</span>
            <span class="donut-leg-val" id="legExisting">â€”</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Status bar chart -->
    <div class="chart-card">
      <div class="chart-head">
        <div>
          <div class="chart-name">Top Illegal Zones</div>
          <div class="chart-desc">Zoning codes with highest violation count</div>
        </div>
        <div>
          <div class="chart-total-val" id="topZoneTotal">â€”</div>
          <div class="chart-total-lbl">Total Illegal</div>
        </div>
      </div>
      <div class="bar-list" id="topZoneBars"></div>
    </div>

  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION 3 â€” FULL ZONING BREAKDOWN TABLE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="section-label" style="margin-top:32px;">
    <span class="section-title">Zoning Classification Breakdown</span>
    <span class="section-meta" id="zoningMeta">â€” zones detected</span>
  </div>

  <div class="chart-card full" style="margin-bottom:4px;">
    <div class="chart-head">
      <div>
        <div class="chart-name">All Zones â€” Illegal Construction Count</div>
        <div class="chart-desc">Ranked by enforcement priority Â· Live from feature layer</div>
      </div>
      <div>
        <div class="chart-total-val" id="zoningTableTotal">â€”</div>
        <div class="chart-total-lbl">Total Illegal</div>
      </div>
    </div>
    <table class="zone-table">
      <thead>
        <tr>
          <th style="width:36px">#</th>
          <th>Zone Code</th>
          <th>Zone Type</th>
          <th>Illegal Count</th>
          <th>Share of Total</th>
        </tr>
      </thead>
      <tbody id="zoningTableBody"></tbody>
    </table>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION 4 â€” SECTOR BREAKDOWN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="section-label" style="margin-top:32px;">
    <span class="section-title">Sector Breakdown</span>
    <span class="section-meta" id="sectorMeta">â€” sectors</span>
  </div>

  <div class="charts-row">
    <div class="chart-card">
      <div class="chart-head">
        <div>
          <div class="chart-name">Illegal Buildings by Sector</div>
          <div class="chart-desc">Top sectors by violation count</div>
        </div>
        <div>
          <div class="chart-total-val" id="sectorTotal">â€”</div>
          <div class="chart-total-lbl">Total Illegal</div>
        </div>
      </div>
      <div class="bar-list" id="sectorBars"></div>
    </div>

    <div class="chart-card">
      <div class="chart-head">
        <div>
          <div class="chart-name">Total Buildings by Sector</div>
          <div class="chart-desc">All buildings regardless of status</div>
        </div>
      </div>
      <div class="bar-list" id="sectorTotalBars"></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION 5 â€” ZONING BAR CHART (Full Width)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="section-label" style="margin-top:32px;">
    <span class="section-title">Zoning Distribution</span>
    <span class="section-meta">All buildings by zone code</span>
  </div>

  <div class="chart-card" style="margin-bottom:4px;">
    <div class="chart-head">
      <div>
        <div class="chart-name">Total Buildings per Zone Code</div>
        <div class="chart-desc">Spatial distribution across zoning classifications</div>
      </div>
    </div>
    <div class="bar-list" id="zoneTotalBars"></div>
  </div>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="footer-left">
      <span class="footer-logo">ESRI Rwanda</span>
      <span class="footer-text">Rubavu District Â· Western Province Â· Rwanda</span>
    </div>
    <span class="footer-right" id="footerServiceUrl">gh.space.gov.rw Â· FeatureServer/1</span>
  </footer>

</div><!-- /wrap -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SERVICE_URL   = 'https://gh.space.gov.rw/server/rest/services/Rubavu_Buildings/FeatureServer/1';
const TOKEN_URL     = 'https://gh.space.gov.rw/portal/sharing/rest/generateToken';
// â”€â”€ Set credentials below OR leave blank to use the manual token input â”€â”€
const AUTO_USER     = '';   // e.g. 'svc_dashboard'
const AUTO_PASS     = '';   // e.g. 'yourpassword'

const FIELDS = {
  status:   'legal_t',
  zone:     'zone_code',
  sector:   'sector',
  cell:     'cell',
  village:  'village'
};

// Status field values â€” adjust if your domain uses different labels
const STATUS = {
  legal:    'Legal',
  illegal:  'Illegal',
  existing: 'Existing'
};

// Zone code labels
const ZONE_LABELS = {
  'R1A': 'Low Density Residential', 'R1B': 'Rural Residential',
  'R2':  'Medium Density',          'R3':  'Medium Expansion',
  'R4':  'High Density',            'R1':  'Residential',
  'C1':  'Mixed Commercial',        'C3':  'City Commercial',
  'C4':  'Commercial Zone 4',       'A1':  'Agriculture',
  'A2':  'Agriculture Zone 2',      'T1':  'Road Reserve',
  'T2':  'Transport 2',             'T3':  'Transport 3',
  'T4':  'Transport 4',             'F1':  'Forest Reserve 1',
  'F5':  'Forest Reserve 5',        'ET':  'Eco-Tourism',
  'I1':  'Light Industrial',        'I2':  'Medium Industrial',
  'I3':  'Heavy Industrial',        'PF1': 'Public Facilities 1',
  'PF2': 'Public Facilities 2',     'PF3': 'Public Facilities 3',
  'PF4': 'Public Facilities 4',     'PF5': 'Public Facilities 5',
  'PF6': 'Public Facilities 6',     'PA':  'Protected Area',
  'W1B': 'Wetland 1B',              'W2':  'Wetland 2',
  'W3':  'Wetland 3',               'U':   'Urban',
  'B1':  'Buffer Zone 1',           'B2':  'Buffer Zone 2',
  'B4':  'Buffer Zone 4',           'WB':  'Water Body',
  'OS':  'Open Space'
};

// Zone chip colors
const ZONE_COLORS = {
  'R1A':'#ffec18','R1B':'#ffebb0','R2':'#ffbb36','R3':'#ff7f00',
  'R4':'#ff5a25','R1':'#ffff7f','C1':'#cc3366','C3':'#960202',
  'C4':'#cc0033','A1':'#6e8131','A2':'#8ba03c','T1':'#b2b2b2',
  'T2':'#999999','T3':'#888888','T4':'#777777','F1':'#4a6e28',
  'F5':'#666666','ET':'#888888','I1':'#8c4b00','I2':'#6e3800',
  'I3':'#502800','PF1':'#4444cc','PF2':'#5555dd','PF3':'#6666ee',
  'PF4':'#7777ff','PF5':'#8888ff','PF6':'#9999ff','PA':'#00aa66',
  'W1B':'#0088bb','W2':'#0099cc','W3':'#00aadd','U':'#aaaaaa',
  'B1':'#556655','B2':'#667766','B4':'#778877','WB':'#005588','OS':'#338844'
};

let TOKEN = '';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOKEN GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generateToken(username, password) {
  const params = new URLSearchParams({
    username,
    password,
    client:     'referer',
    referer:    window.location.origin || 'https://gilbert-uwonkunda.github.io',
    expiration: '120',
    f:          'json'
  });
  const res  = await fetch(TOKEN_URL, { method: 'POST', body: params });
  const json = await res.json();
  if (json.error) throw new Error('Auth failed: ' + json.error.message);
  if (!json.token) throw new Error('No token returned from portal');
  return json.token;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fmt  = n => (n ?? 0).toLocaleString();
const fmtK = n => n >= 1000 ? (n/1000).toFixed(1) + 'K' : String(n ?? 0);
const pct  = (a, b) => b > 0 ? (a/b*100).toFixed(1) + '%' : '0%';

function el(id) { return document.getElementById(id); }

function showLoading(v)  { el('loadingOverlay').classList.toggle('visible', v); }
function showError(msg)  {
  el('errorMsg').textContent = msg || 'Unknown error';
  el('errorOverlay').classList.add('visible');
}
function hideError() { el('errorOverlay').classList.remove('visible'); }

function setVal(id, v, animate = true) {
  const node = el(id);
  if (!node) return;
  node.classList.remove('skeleton');
  if (animate) {
    node.style.opacity = '0';
    node.textContent = v;
    setTimeout(() => { node.style.transition='opacity 0.4s'; node.style.opacity = '1'; }, 50);
  } else {
    node.textContent = v;
  }
}

function skeletonAll() {
  ['kpiTotal','kpiLegal','kpiIllegal','kpiExisting','kpiCompliance',
   'kpiLegalPct','kpiIllegalPct','kpiExistingPct','kpiComplianceSub',
   'topZoneTotal','zoningTableTotal','sectorTotal'].forEach(id => {
    const n = el(id);
    if (n) { n.textContent = 'Â·Â·Â·'; n.classList.add('skeleton'); }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ARCGIS REST QUERY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function queryStats(where, groupField) {
  const params = new URLSearchParams({
    where: where,
    groupByFieldsForStatistics: groupField,
    outStatistics: JSON.stringify([{
      statisticType: 'count',
      onStatisticField: 'OBJECTID',
      outStatisticFieldName: 'cnt'
    }]),
    returnGeometry: false,
    f: 'json'
  });
  if (TOKEN) params.set('token', TOKEN);

  const res = await fetch(`${SERVICE_URL}/query?${params}`, { method: 'GET' });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const json = await res.json();
  if (json.error) {
    if (json.error.code === 499 || json.error.code === 498) {
      el('authPanel').classList.add('visible');
      throw new Error('Token required â€” paste your ArcGIS token above');
    }
    throw new Error(json.error.message);
  }
  return json.features || [];
}

async function queryCount(where) {
  const params = new URLSearchParams({
    where: where,
    returnCountOnly: true,
    f: 'json'
  });
  if (TOKEN) params.set('token', TOKEN);
  const res = await fetch(`${SERVICE_URL}/query?${params}`);
  const json = await res.json();
  if (json.error) throw new Error(json.error.message);
  return json.count || 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAll() {
  hideError();
  skeletonAll();
  showLoading(true);

  const btn = el('refreshBtn');
  btn.classList.add('spinning');

  try {
    // â”€â”€ 0. Auto-generate token if credentials provided
    if (!TOKEN && AUTO_USER && AUTO_PASS) {
      try {
        TOKEN = await generateToken(AUTO_USER, AUTO_PASS);
        el('authPanel').classList.remove('visible');
      } catch(authErr) {
        // Fall through to manual token input
        TOKEN = '';
      }
    }

    // â”€â”€ 1. Total count
    const total = await queryCount('1=1');

    // â”€â”€ 2. Status counts
    const statusRows = await queryStats('1=1', FIELDS.status);
    let legal = 0, illegal = 0, existing = 0;
    statusRows.forEach(f => {
      const v = f.attributes[FIELDS.status];
      const c = f.attributes.cnt;
      const vl = (v || '').toLowerCase();
      if (vl === STATUS.legal.toLowerCase())    legal    += c;
      else if (vl === STATUS.illegal.toLowerCase())  illegal  += c;
      else existing += c;
    });

    // â”€â”€ 3. Zoning Ã— status
    const zoningRows = await queryStats('1=1', `${FIELDS.zone},${FIELDS.status}`);

    // â”€â”€ 4. Sector Ã— status
    const sectorRows = await queryStats('1=1', `${FIELDS.sector},${FIELDS.status}`);

    showLoading(false);
    btn.classList.remove('spinning');

    renderKPIs(total, legal, illegal, existing);
    renderDonut(legal, illegal, existing);
    renderZoning(zoningRows, illegal);
    renderSectors(sectorRows);
    renderZoneTotals(zoningRows);

    el('lastUpdated').textContent = new Date().toLocaleString('en-RW', {
      day:'2-digit', month:'short', year:'numeric',
      hour:'2-digit', minute:'2-digit'
    });
    el('totalBuildingsNote').textContent = `${fmt(total)} buildings Â· ${statusRows.length} status groups`;

  } catch(err) {
    showLoading(false);
    btn.classList.remove('spinning');
    showError(err.message);
    console.error(err);
  }
}

function retryLoad() {
  hideError();
  TOKEN = '';
  loadAll();
}

function applyToken() {
  TOKEN = el('tokenInput').value.trim();
  if (TOKEN) {
    el('authPanel').classList.remove('visible');
    loadAll();
  }
}

async function loginWithCredentials() {
  const user = el('userInput').value.trim();
  const pass = el('passInput').value.trim();
  if (!user || !pass) return;
  try {
    showLoading(true);
    TOKEN = await generateToken(user, pass);
    el('authPanel').classList.remove('visible');
    loadAll();
  } catch(err) {
    showLoading(false);
    showError('Login failed: ' + err.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderKPIs(total, legal, illegal, existing) {
  const verified = legal + illegal;
  const compliance = verified > 0 ? (legal / verified * 100).toFixed(1) + '%' : 'â€”';

  setVal('kpiTotal',      fmt(total));
  setVal('kpiLegal',      fmt(legal));
  setVal('kpiIllegal',    fmt(illegal));
  setVal('kpiExisting',   fmt(existing));
  setVal('kpiCompliance', compliance);

  setVal('kpiLegalPct',    pct(legal,    total), false);
  setVal('kpiIllegalPct',  pct(illegal,  total), false);
  setVal('kpiExistingPct', pct(existing, total), false);
  setVal('kpiComplianceSub', `${fmt(legal)} of ${fmt(verified)} verified`, false);
}

function renderDonut(legal, illegal, existing) {
  const total = legal + illegal + existing;
  if (total === 0) return;

  const R = 54, cx = 70, cy = 70;
  const circ = 2 * Math.PI * R;

  const segments = [
    { val: legal,    color: 'var(--green)',  label: 'Legal' },
    { val: illegal,  color: 'var(--red)',    label: 'Illegal' },
    { val: existing, color: 'var(--yellow)', label: 'Existing' }
  ];

  let offset = 0;
  const svgEl = el('donutSvg');
  // Clear existing segments
  svgEl.querySelectorAll('.seg').forEach(s => s.remove());
  // Remove center text
  svgEl.querySelectorAll('.center-text').forEach(s => s.remove());

  segments.forEach(seg => {
    const frac = seg.val / total;
    const dash = frac * circ;
    const gap  = circ - dash;
    const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
    circle.setAttribute('cx', cx);
    circle.setAttribute('cy', cy);
    circle.setAttribute('r',  R);
    circle.setAttribute('fill', 'none');
    circle.setAttribute('stroke', seg.color);
    circle.setAttribute('stroke-width', '22');
    circle.setAttribute('stroke-dasharray', `${dash} ${gap}`);
    circle.setAttribute('stroke-dashoffset', -offset * circ);
    circle.setAttribute('transform', `rotate(-90 ${cx} ${cy})`);
    circle.classList.add('seg');
    circle.style.transition = 'stroke-dasharray 0.6s ease';
    svgEl.appendChild(circle);
    offset += frac;
  });

  // Center text
  const compVal = illegal + legal > 0 ? (legal/(illegal+legal)*100).toFixed(0)+'%' : 'â€”';
  const text1 = document.createElementNS('http://www.w3.org/2000/svg','text');
  text1.setAttribute('x', cx); text1.setAttribute('y', cy - 6);
  text1.setAttribute('text-anchor','middle');
  text1.setAttribute('fill','#e8f0f7');
  text1.setAttribute('font-family','JetBrains Mono, monospace');
  text1.setAttribute('font-size','16');
  text1.setAttribute('font-weight','700');
  text1.textContent = compVal;
  text1.classList.add('center-text');
  svgEl.appendChild(text1);

  const text2 = document.createElementNS('http://www.w3.org/2000/svg','text');
  text2.setAttribute('x', cx); text2.setAttribute('y', cy + 11);
  text2.setAttribute('text-anchor','middle');
  text2.setAttribute('fill','#2e4a60');
  text2.setAttribute('font-family','Space Grotesk, sans-serif');
  text2.setAttribute('font-size','9');
  text2.textContent = 'COMPLIANCE';
  text2.classList.add('center-text');
  svgEl.appendChild(text2);

  setVal('legLegal',    fmt(legal),    false);
  setVal('legIllegal',  fmt(illegal),  false);
  setVal('legExisting', fmt(existing), false);
}

function renderZoning(rows, totalIllegal) {
  // Aggregate by zone code
  const byZone = {};
  rows.forEach(f => {
    const zone   = f.attributes[FIELDS.zone] || 'Unknown';
    const status = (f.attributes[FIELDS.status] || '').toLowerCase();
    const cnt    = f.attributes.cnt || 0;
    if (!byZone[zone]) byZone[zone] = { total: 0, illegal: 0, legal: 0, existing: 0 };
    byZone[zone].total += cnt;
    if (status === STATUS.illegal.toLowerCase())  byZone[zone].illegal  += cnt;
    else if (status === STATUS.legal.toLowerCase()) byZone[zone].legal  += cnt;
    else byZone[zone].existing += cnt;
  });

  const sorted = Object.entries(byZone)
    .map(([code, d]) => ({ code, ...d }))
    .sort((a,b) => b.illegal - a.illegal);

  const totalIll = sorted.reduce((s,z) => s + z.illegal, 0);
  const maxIll   = sorted[0]?.illegal || 1;

  el('zoningMeta').textContent = `${sorted.length} zones detected`;
  setVal('zoningTableTotal', fmt(totalIll), false);

  // â”€â”€ Top zone bars (top 8)
  const topZones = sorted.filter(z => z.illegal > 0).slice(0, 8);
  const topMax   = topZones[0]?.illegal || 1;
  setVal('topZoneTotal', fmt(totalIll), false);

  el('topZoneBars').innerHTML = topZones.map(z => {
    const w     = (z.illegal / topMax * 100).toFixed(1);
    const color = ZONE_COLORS[z.code] || '#555';
    const isDark = isLightColor(color);
    return `
      <div class="bar-row">
        <span class="bar-label">${z.code}</span>
        <div class="bar-track">
          <div class="bar-fill" style="width:${w}%;background:${color}">
            <span class="bar-val" style="color:${isDark?'#0d1520':'rgba(0,0,0,0.75)'}">${fmt(z.illegal)}</span>
          </div>
        </div>
        <span class="bar-pct">${pct(z.illegal, totalIll)}</span>
      </div>`;
  }).join('');

  // â”€â”€ Full zoning table
  el('zoningTableBody').innerHTML = sorted.map((z, i) => {
    const color    = ZONE_COLORS[z.code] || '#555';
    const isDark   = isLightColor(color);
    const isTop    = i < 3 && z.illegal > 0;
    const sharePct = pct(z.illegal, totalIll);
    const shareW   = totalIll > 0 ? (z.illegal / totalIll * 100).toFixed(1) : 0;
    return `
      <tr>
        <td>
          <span class="rank-badge ${isTop?'top':''}">${i+1}</span>
        </td>
        <td>
          <span class="zone-chip" style="background:${color};color:${isDark?'#0d1520':'#fff'}">${z.code}</span>
        </td>
        <td>
          <div class="zone-name">${ZONE_LABELS[z.code] || z.code}</div>
          <div class="zone-province">${fmt(z.total)} total buildings</div>
        </td>
        <td>${fmt(z.illegal)}</td>
        <td>
          <div class="mini-bar-wrap">
            <div class="mini-bar">
              <div class="mini-bar-fill" style="width:${shareW}%;background:${color}"></div>
            </div>
            <span style="font-family:var(--mono);font-size:10px;color:var(--text3);white-space:nowrap">${sharePct}</span>
          </div>
        </td>
      </tr>`;
  }).join('');
}

function renderSectors(rows) {
  const bySector = {};
  rows.forEach(f => {
    const sec    = f.attributes[FIELDS.sector] || 'Unknown';
    const status = (f.attributes[FIELDS.status] || '').toLowerCase();
    const cnt    = f.attributes.cnt || 0;
    if (!bySector[sec]) bySector[sec] = { total: 0, illegal: 0 };
    bySector[sec].total   += cnt;
    if (status === STATUS.illegal.toLowerCase()) bySector[sec].illegal += cnt;
  });

  const sorted = Object.entries(bySector)
    .map(([name, d]) => ({ name, ...d }))
    .sort((a,b) => b.illegal - a.illegal);

  const totalIll = sorted.reduce((s,x) => s + x.illegal, 0);
  const maxIll   = sorted[0]?.illegal || 1;
  const maxTot   = Math.max(...sorted.map(s => s.total)) || 1;

  el('sectorMeta').textContent = `${sorted.length} sectors`;
  setVal('sectorTotal', fmt(totalIll), false);

  // Illegal bars (top 10)
  el('sectorBars').innerHTML = sorted.slice(0, 10).map(s => {
    const w = (s.illegal / maxIll * 100).toFixed(1);
    const shade = gradientShade(s.illegal, maxIll);
    return `
      <div class="bar-row">
        <span class="bar-label" title="${s.name}">${s.name}</span>
        <div class="bar-track">
          <div class="bar-fill" style="width:${w}%;background:${shade}">
            <span class="bar-val">${fmt(s.illegal)}</span>
          </div>
        </div>
        <span class="bar-pct">${pct(s.illegal, totalIll)}</span>
      </div>`;
  }).join('');

  // Total bars (top 10)
  el('sectorTotalBars').innerHTML = sorted
    .slice().sort((a,b) => b.total - a.total)
    .slice(0, 10).map(s => {
      const w = (s.total / maxTot * 100).toFixed(1);
      return `
        <div class="bar-row">
          <span class="bar-label" title="${s.name}">${s.name}</span>
          <div class="bar-track">
            <div class="bar-fill" style="width:${w}%;background:linear-gradient(90deg,#0099cc,#00d4ff)">
              <span class="bar-val">${fmtK(s.total)}</span>
            </div>
          </div>
          <span class="bar-pct">${pct(s.total, sorted.reduce((a,x)=>a+x.total,0))}</span>
        </div>`;
    }).join('');
}

function renderZoneTotals(rows) {
  const byZone = {};
  rows.forEach(f => {
    const zone = f.attributes[FIELDS.zone] || 'Unknown';
    const cnt  = f.attributes.cnt || 0;
    byZone[zone] = (byZone[zone] || 0) + cnt;
  });
  const sorted = Object.entries(byZone).sort((a,b) => b[1]-a[1]);
  const maxVal = sorted[0]?.[1] || 1;

  el('zoneTotalBars').innerHTML = sorted.map(([code, cnt]) => {
    const w     = (cnt / maxVal * 100).toFixed(1);
    const color = ZONE_COLORS[code] || '#444';
    const isDark = isLightColor(color);
    return `
      <div class="bar-row">
        <span class="bar-label">${code}</span>
        <div class="bar-track">
          <div class="bar-fill" style="width:${w}%;background:${color}">
            <span class="bar-val" style="color:${isDark?'#0d1520':'rgba(0,0,0,0.75)'}">${fmtK(cnt)}</span>
          </div>
        </div>
        <span class="bar-pct">${pct(cnt, sorted.reduce((s,[,v])=>s+v,0))}</span>
      </div>`;
  }).join('');
}

// â”€â”€ Helpers
function isLightColor(hex) {
  const lightList = ['#ffec18','#ffebb0','#ffbb36','#b2b2b2','#ffff7f','#ffe600','#c6e0b4','#8ba03c','#6e8131'];
  return lightList.some(c => c.toLowerCase() === (hex||'').toLowerCase());
}

function gradientShade(val, max) {
  const t = val / max;
  const r = Math.round(180 + t * 75);
  const g = Math.round(80  - t * 60);
  const b = Math.round(80  - t * 60);
  return `rgb(${r},${g},${b})`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT â€” show auth panel immediately if no credentials set
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if (!AUTO_USER) {
  el('authPanel').classList.add('visible');
}
loadAll();
</script>
</body>
</html>
