<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rubavu — Building & Zoning Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,500;12..96,600;12..96,700;12..96,800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
<script src="https://js.arcgis.com/4.29/"></script>
<style>
:root {
  --bg:        #f0f2f5;
  --surface:   #ffffff;
  --surface2:  #f7f8fa;
  --border:    #e3e7ef;
  --border2:   #cbd1de;
  --ink:       #0b1320;
  --ink2:      #4a5568;
  --ink3:      #9aa3b5;
  --blue:      #1a56db;
  --blue-lt:   #ebf0fe;
  --blue-mid:  #3b6fd4;
  --green:     #059669;
  --green-lt:  #ecfdf5;
  --amber:     #b45309;
  --amber-lt:  #fffbeb;
  --red:       #dc2626;
  --red-lt:    #fef2f2;
  --teal:      #0891b2;
  --teal-lt:   #ecfeff;
  --r: 12px;
  --r-sm: 7px;
  --shadow-sm: 0 1px 3px rgba(11,19,32,.06), 0 1px 2px rgba(11,19,32,.04);
  --shadow:    0 4px 12px rgba(11,19,32,.07), 0 2px 4px rgba(11,19,32,.04);
  --shadow-lg: 0 12px 40px rgba(11,19,32,.10), 0 4px 12px rgba(11,19,32,.05);
  --font:  'Bricolage Grotesque', sans-serif;
  --mono:  'DM Mono', monospace;
  --transition: 0.18s cubic-bezier(0.4,0,0.2,1);
}

*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}

body{
  font-family:var(--font);
  background:var(--bg);
  color:var(--ink);
  display:grid;
  grid-template-rows:58px 1fr;
  height:100vh;
}

/* ══ TOPBAR ══ */
.topbar{
  background:var(--surface);
  border-bottom:1.5px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 20px;
  gap:12px;
  box-shadow:var(--shadow-sm);
  z-index:50;
}

.tb-brand{display:flex;align-items:center;gap:10px;}
.tb-logo{
  width:34px;height:34px;
  background:linear-gradient(135deg,var(--blue) 0%,var(--teal) 100%);
  border-radius:9px;
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;
  box-shadow:0 2px 8px rgba(26,86,219,.3);
}
.tb-logo svg{width:18px;height:18px;fill:none;stroke:white;stroke-width:2;}
.tb-title{font-size:16px;font-weight:800;color:var(--ink);letter-spacing:-.4px;}
.tb-district{
  font-size:12px;font-weight:500;
  color:var(--ink3);
  padding-left:12px;
  border-left:1.5px solid var(--border);
  margin-left:2px;
}

.tb-pills{display:flex;align-items:center;gap:8px;}

.tb-pill{
  display:flex;align-items:center;gap:6px;
  padding:5px 12px;
  border-radius:100px;
  border:1.5px solid var(--border);
  background:var(--surface2);
  font-size:12px;font-weight:500;color:var(--ink2);
}
.tb-pill strong{font-family:var(--mono);font-size:13px;font-weight:500;}
.tb-pill.b strong{color:var(--blue);}
.tb-pill.g strong{color:var(--green);}
.tb-pill.a strong{color:var(--amber);}
.dot{width:6px;height:6px;border-radius:50%;background:var(--ink3);}
.dot.b{background:var(--blue);}
.dot.g{background:var(--green);}
.dot.a{background:var(--amber);}

.tb-refresh{
  display:flex;align-items:center;gap:6px;
  padding:7px 14px;
  background:var(--blue);
  border:none;border-radius:var(--r-sm);
  color:white;font-family:var(--font);font-size:12px;font-weight:700;
  cursor:pointer;transition:background var(--transition);box-shadow:0 2px 8px rgba(26,86,219,.25);
}
.tb-refresh:hover{background:var(--blue-mid);}
.tb-refresh svg{width:13px;height:13px;stroke:white;fill:none;stroke-width:2.5;}
.tb-refresh.spin svg{animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* ══ MAIN GRID ══ */
.main{
  display:grid;
  grid-template-columns:260px 1fr 320px;
  overflow:hidden;
  height:100%;
}

/* ══ LEFT — FILTERS ══ */
.filters{
  background:var(--surface);
  border-right:1.5px solid var(--border);
  display:flex;flex-direction:column;
  overflow:hidden;
}

.panel-hd{
  padding:16px 16px 12px;
  border-bottom:1px solid var(--border);
  flex-shrink:0;
}
.panel-hd-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--ink3);}
.panel-hd-sub{font-size:12px;font-weight:500;color:var(--ink2);margin-top:2px;}

.active-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px;min-height:0;}
.tag{
  display:inline-flex;align-items:center;gap:4px;
  padding:2px 8px 2px 9px;
  background:var(--blue-lt);border:1px solid rgba(26,86,219,.2);
  border-radius:100px;font-size:11px;font-weight:600;color:var(--blue);
}
.tag button{background:none;border:none;color:var(--blue);cursor:pointer;font-size:14px;line-height:1;opacity:.6;}
.tag button:hover{opacity:1;}

.filters-body{
  flex:1;overflow-y:auto;
  padding:14px 16px;
  display:flex;flex-direction:column;gap:14px;
}
.filters-body::-webkit-scrollbar{width:3px;}
.filters-body::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

.fg{display:flex;flex-direction:column;gap:5px;}

.fl{
  font-size:10px;font-weight:700;text-transform:uppercase;
  letter-spacing:.8px;color:var(--ink2);
  display:flex;justify-content:space-between;align-items:center;
}
.fl-clr{font-size:10px;font-weight:600;color:var(--blue);cursor:pointer;text-transform:none;letter-spacing:0;display:none;}
.fl-clr.on{display:block;}

.fsel{
  width:100%;padding:8px 30px 8px 10px;
  background:var(--surface2)
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='11' height='11' viewBox='0 0 24 24' fill='none' stroke='%239aa3b5' stroke-width='2.5'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E")
    no-repeat right 10px center;
  border:1.5px solid var(--border);
  border-radius:var(--r-sm);
  color:var(--ink);font-family:var(--font);font-size:13px;
  outline:none;cursor:pointer;appearance:none;
  transition:border-color var(--transition);
}
.fsel:focus{border-color:var(--blue);}
.fsel.on{border-color:var(--blue);background-color:var(--blue-lt);color:var(--blue);font-weight:600;}

.zone-grid{display:flex;flex-wrap:wrap;gap:4px;max-height:180px;overflow-y:auto;}
.zc{
  padding:3px 8px;border-radius:4px;
  font-family:var(--mono);font-size:9px;font-weight:500;
  cursor:pointer;border:1.5px solid transparent;
  transition:all var(--transition);opacity:.8;
}
.zc:hover{opacity:1;transform:translateY(-1px);}
.zc.on{opacity:1;border-color:rgba(0,0,0,.3);box-shadow:0 0 0 2px rgba(0,0,0,.1);}

.filters-foot{
  padding:12px 16px;border-top:1px solid var(--border);flex-shrink:0;
}
.clr-all{
  width:100%;padding:8px;background:var(--surface2);
  border:1.5px solid var(--border2);border-radius:var(--r-sm);
  color:var(--ink2);font-family:var(--font);font-size:12px;font-weight:600;
  cursor:pointer;transition:all var(--transition);
}
.clr-all:hover{background:var(--red-lt);border-color:var(--red);color:var(--red);}

/* ══ CENTER — MAP ══ */
.map-wrap{position:relative;overflow:hidden;}
#viewDiv{width:100%;height:100%;}

.map-chip{
  position:absolute;top:14px;left:50%;transform:translateX(-50%);
  background:rgba(255,255,255,.95);backdrop-filter:blur(8px);
  border:1px solid var(--border);border-radius:100px;
  padding:6px 16px;font-size:11px;font-weight:500;color:var(--ink2);
  box-shadow:var(--shadow-sm);pointer-events:none;z-index:10;
  white-space:nowrap;transition:opacity .3s;
}
.map-chip.hide{opacity:0;}

.map-info{
  position:absolute;bottom:18px;left:14px;
  background:var(--surface);border:1px solid var(--border);border-radius:var(--r);
  padding:10px 14px;box-shadow:var(--shadow);
  font-size:11px;color:var(--ink2);pointer-events:none;z-index:10;
  display:none;max-width:220px;
}
.map-info strong{display:block;font-size:13px;font-weight:700;color:var(--ink);margin-bottom:2px;}

/* ══ RIGHT — STATS ══ */
.stats{
  background:var(--surface);
  border-left:1.5px solid var(--border);
  display:flex;flex-direction:column;
  overflow:hidden;
}

/* KPI strip */
.kpi-strip{
  display:grid;grid-template-columns:1fr 1fr 1fr;
  border-bottom:1px solid var(--border);
  flex-shrink:0;
}
.kpi{
  padding:14px 12px 12px;
  border-right:1px solid var(--border);
  position:relative;
}
.kpi:last-child{border-right:none;}
.kpi::before{
  content:'';position:absolute;
  top:0;left:0;right:0;height:3px;
  background:var(--kc);
  border-radius:0 0 3px 3px;
}
.kpi.b{--kc:var(--blue);}
.kpi.g{--kc:var(--green);}
.kpi.a{--kc:var(--amber);}

.kpi-lbl{font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--ink3);font-weight:700;margin-bottom:4px;}
.kpi-val{font-family:var(--mono);font-size:19px;font-weight:500;color:var(--kc);line-height:1;}
.kpi-sub{font-size:9px;color:var(--ink3);margin-top:3px;}
.kpi-icon{
  width:26px;height:26px;border-radius:6px;
  background:rgba(0,0,0,.04);
  display:flex;align-items:center;justify-content:center;
  margin-bottom:8px;
  color:var(--kc);
}

/* Zone bars */
.zbar-sec{
  border-bottom:1px solid var(--border);
  padding:12px 14px;flex-shrink:0;
}
.sec-hd{
  font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;
  color:var(--ink3);margin-bottom:10px;
  display:flex;justify-content:space-between;align-items:center;
}
.sec-hd span{font-family:var(--mono);font-size:10px;font-weight:400;}

.zb-list{display:flex;flex-direction:column;gap:5px;}
.zb{display:flex;align-items:center;gap:7px;}
.zb-code{
  width:38px;padding:2px 0;border-radius:4px;
  font-family:var(--mono);font-size:9px;font-weight:700;
  text-align:center;flex-shrink:0;cursor:pointer;
  transition:transform var(--transition);
}
.zb-code:hover{transform:scale(1.07);}
.zb-track{flex:1;height:17px;background:var(--bg);border-radius:3px;overflow:hidden;}
.zb-fill{
  height:100%;border-radius:3px;
  display:flex;align-items:center;justify-content:flex-end;
  padding-right:5px;min-width:32px;
  transition:width .55s cubic-bezier(.4,0,.2,1);
}
.zb-fill span{font-family:var(--mono);font-size:9px;font-weight:700;}
.zb-pct{width:30px;text-align:right;font-family:var(--mono);font-size:9px;color:var(--ink3);flex-shrink:0;}

/* Table */
.tbl-sec{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.tbl-hd{
  padding:10px 14px 8px;
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  flex-shrink:0;
}
.tbl-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--ink3);}
.tbl-right{display:flex;align-items:center;gap:8px;}
.tbl-count{font-family:var(--mono);font-size:10px;color:var(--ink3);}

.dl-btn{
  display:flex;align-items:center;gap:5px;
  padding:5px 10px;
  background:var(--green-lt);border:1.5px solid rgba(5,150,105,.2);
  border-radius:var(--r-sm);color:var(--green);
  font-family:var(--font);font-size:11px;font-weight:700;
  cursor:pointer;transition:all var(--transition);
}
.dl-btn:hover{background:#d1fae5;}
.dl-btn svg{width:11px;height:11px;stroke:var(--green);fill:none;stroke-width:2.5;}

.tbl-wrap{flex:1;overflow-y:auto;overflow-x:hidden;}
.tbl-wrap::-webkit-scrollbar{width:3px;}
.tbl-wrap::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

table{width:100%;border-collapse:collapse;font-size:11px;}
thead th{
  position:sticky;top:0;
  background:var(--surface2);
  padding:7px 10px;text-align:left;
  font-size:9px;text-transform:uppercase;letter-spacing:.8px;
  color:var(--ink3);font-weight:700;border-bottom:1px solid var(--border);
  white-space:nowrap;
}
tbody tr{border-bottom:1px solid var(--bg);cursor:pointer;transition:background var(--transition);}
tbody tr:hover{background:var(--blue-lt);}
tbody tr.sel{background:var(--blue-lt);}
tbody td{padding:7px 10px;color:var(--ink2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:90px;}
tbody td:first-child{color:var(--ink);font-weight:600;}

.chip{
  display:inline-block;padding:2px 6px;border-radius:3px;
  font-family:var(--mono);font-size:9px;font-weight:700;
}
.cnt{font-family:var(--mono);font-size:11px;font-weight:500;color:var(--ink);}

/* Loading overlay */
.overlay{
  position:fixed;inset:0;z-index:200;
  background:rgba(240,242,245,.9);backdrop-filter:blur(6px);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;
}
.overlay.off{display:none;}
.ring{
  width:38px;height:38px;border-radius:50%;
  border:3px solid var(--border2);border-top-color:var(--blue);
  animation:spin .7s linear infinite;
}
.ov-txt{font-size:13px;font-weight:500;color:var(--ink2);}

/* ArcGIS widget overrides */
.esri-widget{font-family:var(--font)!important;border-radius:var(--r-sm)!important;}
.esri-ui-top-right{gap:8px!important;}

/* Entrance animations */
@keyframes fadeUp{
  from{opacity:0;transform:translateY(8px);}
  to{opacity:1;transform:translateY(0);}
}
.anim{animation:fadeUp .3s ease forwards;}
.d1{animation-delay:.05s;}
.d2{animation-delay:.10s;}
.d3{animation-delay:.15s;}
.d4{animation-delay:.20s;}
.d5{animation-delay:.25s;}

.empty{
  display:flex;flex-direction:column;align-items:center;
  justify-content:center;padding:28px 16px;gap:6px;
  color:var(--ink3);font-size:12px;text-align:center;
}
.empty svg{width:28px;height:28px;stroke:var(--ink3);fill:none;stroke-width:1.5;opacity:.4;}
</style>
</head>
<body>

<div class="overlay" id="ov">
  <div class="ring"></div>
  <div class="ov-txt" id="ovTxt">Connecting to feature layer…</div>
</div>

<!-- ══ TOPBAR ══ -->
<header class="topbar">
  <div class="tb-brand">
    <div class="tb-logo">
      <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    </div>
    <span class="tb-title">Rubavu District</span>
    <span class="tb-district">Building &amp; Masterplan Compliance</span>
  </div>
  <div class="tb-pills">
    <div class="tb-pill b"><span class="dot b"></span>Total <strong id="hTotal">—</strong></div>
    <div class="tb-pill g"><span class="dot g"></span>Legal <strong id="hLegal">—</strong></div>
    <div class="tb-pill a"><span class="dot a"></span>Existing <strong id="hExist">—</strong></div>
    <button class="tb-refresh" id="rfBtn" onclick="refresh()">
      <svg viewBox="0 0 24 24"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
      Refresh
    </button>
  </div>
</header>

<!-- ══ MAIN ══ -->
<div class="main">

  <!-- LEFT — FILTERS -->
  <aside class="filters">
    <div class="panel-hd">
      <div class="panel-hd-title" style="display:flex;align-items:center;gap:6px;">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
        Filters
      </div>
      <div class="panel-hd-sub">Drill into specific areas</div>
      <div class="active-tags" id="actTags"></div>
    </div>

    <div class="filters-body">

      <div class="fg">
        <div class="fl">Sector <span class="fl-clr" id="clrS" onclick="clearF('sector')">Clear</span></div>
        <select class="fsel" id="selS" onchange="onF('sector',this.value)">
          <option value="">All Sectors</option>
        </select>
      </div>

      <div class="fg">
        <div class="fl">Cell <span class="fl-clr" id="clrC" onclick="clearF('cell')">Clear</span></div>
        <select class="fsel" id="selC" onchange="onF('cell',this.value)">
          <option value="">All Cells</option>
        </select>
      </div>

      <div class="fg">
        <div class="fl">Village <span class="fl-clr" id="clrV" onclick="clearF('village')">Clear</span></div>
        <select class="fsel" id="selV" onchange="onF('village',this.value)">
          <option value="">All Villages</option>
        </select>
      </div>

      <div class="fg">
        <div class="fl">Zoning Classification <span class="fl-clr" id="clrZ" onclick="clearF('zone')">Clear</span></div>
        <div class="zone-grid" id="zoneGrid"></div>
      </div>

    </div>

    <div class="filters-foot">
      <button class="clr-all" onclick="clearAll()">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="vertical-align:-1px"><path d="M18 6L6 18M6 6l12 12"/></svg>
        &nbsp;Clear All Filters
      </button>
    </div>
  </aside>

  <!-- CENTER — MAP -->
  <div class="map-wrap">
    <div id="viewDiv"></div>
    <div class="map-chip" id="mapChip">
      <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-1px;margin-right:5px"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="M13 13l6 6"/></svg>
      Click a building to filter by sector
    </div>
    <div class="map-info" id="mapInfo">
      <strong id="miName">—</strong>
      <span id="miDetail">—</span>
    </div>
  </div>

  <!-- RIGHT — STATS -->
  <aside class="stats">

    <!-- KPIs -->
    <div class="kpi-strip">
      <div class="kpi b anim d1">
        <div class="kpi-icon">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        </div>
        <div class="kpi-lbl">Total</div>
        <div class="kpi-val" id="kT">—</div>
        <div class="kpi-sub">Buildings</div>
      </div>
      <div class="kpi g anim d2">
        <div class="kpi-icon">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        </div>
        <div class="kpi-lbl">Legal</div>
        <div class="kpi-val" id="kL">—</div>
        <div class="kpi-sub" id="kLs">—</div>
      </div>
      <div class="kpi a anim d3">
        <div class="kpi-icon">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        </div>
        <div class="kpi-lbl">Existing</div>
        <div class="kpi-val" id="kE">—</div>
        <div class="kpi-sub" id="kEs">—</div>
      </div>
    </div>

    <!-- Zone bars -->
    <div class="zbar-sec anim d4">
      <div class="sec-hd">Zoning Distribution <span id="zoneN">— zones</span></div>
      <div class="zb-list" id="zbList"></div>
    </div>

    <!-- Table -->
    <div class="tbl-sec anim d5">
      <div class="tbl-hd">
        <span class="tbl-title">Building Records</span>
        <div class="tbl-right">
          <span class="tbl-count" id="tblN">— rows</span>
          <button class="dl-btn" onclick="downloadCSV()">
            <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
            CSV
          </button>
        </div>
      </div>
      <div class="tbl-wrap">
        <table>
          <thead>
            <tr>
              <th>Sector</th>
              <th>Zone</th>
              <th>Type</th>
              <th>Total</th>
              <th>Legal</th>
            </tr>
          </thead>
          <tbody id="tbl"></tbody>
        </table>
      </div>
    </div>

  </aside>
</div>

<script>
// ══════════════════════════════════════════════════
// CONFIG — edit these as needed
// ══════════════════════════════════════════════════
const SVC    = 'https://gh.space.gov.rw/server/rest/services/Rubavu_Buildings/FeatureServer/1';
const PORTAL = 'https://gh.space.gov.rw/portal';
const WEBMAP = '4cf12c58e97f4dcf9d4ffd524e085303';

const F = { status:'legal_t', zone:'zone_code', sector:'sector', cell:'cell', village:'village' };
const STATUS = { legal:'Legal', illegal:'Illegal', existing:'Existing' };

const ZONE_COLORS = {
  'R1A':'#ffec18','R1B':'#ffebb0','R2':'#ffbb36','R3':'#ff7f00','R4':'#ff5a25','R1':'#ffe97a',
  'C1':'#cc3366','C3':'#960202','C4':'#cc0033',
  'A1':'#6e8131','A2':'#8ba03c',
  'T1':'#94a3b8','T2':'#78879a','T3':'#6b7a8d','T4':'#5e6b7e',
  'F1':'#4a6e28','F5':'#566e48','ET':'#2d9b6e',
  'I1':'#8c4b00','I2':'#6e3800','I3':'#502800',
  'PF1':'#3b5bdb','PF2':'#4c6ef5','PF3':'#5c7cfa','PF4':'#748ffc','PF5':'#91a7ff','PF6':'#bac8ff',
  'PA':'#00aa66','W1B':'#0088bb','W2':'#0099cc','W3':'#00aadd',
  'U':'#8899aa','B1':'#556655','B2':'#667766','B4':'#778877','WB':'#0055aa','OS':'#338844'
};

const ZONE_NAMES = {
  'R1A':'Low Density Res.','R1B':'Rural Residential','R2':'Medium Density','R3':'Medium Expansion',
  'R4':'High Density','R1':'Residential','C1':'Mixed Commercial','C3':'City Centre',
  'C4':'Commercial','A1':'Agriculture','A2':'Agriculture 2','T1':'Road Reserve',
  'T2':'Transport 2','T3':'Transport 3','T4':'Transport 4','F1':'Forest Reserve',
  'F5':'Forest 5','ET':'Eco-Tourism','I1':'Light Industrial','I2':'Medium Industrial',
  'I3':'Heavy Industrial','PF1':'Public Facility','PF2':'Public Facility 2','PF3':'Public Facility 3',
  'PF4':'Public Facility 4','PF5':'Public Facility 5','PF6':'Public Facility 6',
  'PA':'Protected Area','W1B':'Wetland','W2':'Wetland 2','W3':'Wetland 3',
  'U':'Urban','B1':'Buffer Zone','B2':'Buffer 2','B4':'Buffer 4','WB':'Water Body','OS':'Open Space'
};

// Light-background zones (need dark text)
const LIGHT_Z = new Set(['R1A','R1B','R2','R1','T1','T2','PF5','PF6']);

// ══ State
let filters = {sector:'',cell:'',village:'',zone:''};
let tableRows = [];
let mapView = null, flayer = null;

// ══ Helpers
const $  = id => document.getElementById(id);
const fmt = n  => (n||0).toLocaleString();
const pct = (a,b) => b > 0 ? (a/b*100).toFixed(1)+'%' : '0%';
const isLight = c => LIGHT_Z.has(c);

function setOv(txt){ if(txt){$('ov').classList.remove('off');$('ovTxt').textContent=txt;}else $('ov').classList.add('off'); }

function buildWhere(){
  const parts=[];
  if(filters.sector)  parts.push(`${F.sector}='${filters.sector.replace(/'/g,"''")}'`);
  if(filters.cell)    parts.push(`${F.cell}='${filters.cell.replace(/'/g,"''")}'`);
  if(filters.village) parts.push(`${F.village}='${filters.village.replace(/'/g,"''")}'`);
  if(filters.zone)    parts.push(`${F.zone}='${filters.zone.replace(/'/g,"''")}'`);
  return parts.length ? parts.join(' AND ') : '1=1';
}

async function qStats(where,groupBy){
  const p = new URLSearchParams({
    where, groupByFieldsForStatistics:groupBy,
    outStatistics:JSON.stringify([{statisticType:'count',onStatisticField:'OBJECTID',outStatisticFieldName:'cnt'}]),
    returnGeometry:false, f:'json'
  });
  const r = await fetch(`${SVC}/query?${p}`);
  const j = await r.json();
  if(j.error) throw new Error(j.error.message);
  return j.features||[];
}

async function qDistinct(field,where='1=1'){
  const p = new URLSearchParams({
    where, outFields:field,
    returnDistinctValues:true, returnGeometry:false,
    orderByFields:field, resultRecordCount:500, f:'json'
  });
  const r = await fetch(`${SVC}/query?${p}`);
  const j = await r.json();
  if(j.error) throw new Error(j.error.message);
  return (j.features||[]).map(f=>f.attributes[field]).filter(Boolean).sort();
}

// ══════════════════════════════════════════════════
// MAP — ArcGIS JS API 4.29
// ══════════════════════════════════════════════════
require([
  'esri/config','esri/WebMap','esri/views/MapView',
  'esri/layers/FeatureLayer','esri/widgets/Search','esri/widgets/Home'
],function(esriConfig,WebMap,MapView,FeatureLayer,Search,Home){

  esriConfig.portalUrl = PORTAL;

  const wm = new WebMap({portalItem:{id:WEBMAP,portal:{url:PORTAL}}});

  mapView = new MapView({
    container:'viewDiv', map:wm,
    ui:{components:['zoom']}
  });

  const home = new Home({view:mapView});
  mapView.ui.add(home,'top-left');

  const search = new Search({view:mapView});
  mapView.ui.add(search,'top-right');

  mapView.when(()=>{
    // Find buildings layer in webmap
    wm.layers.forEach(l=>{
      if(l.title && l.title.toLowerCase().includes('building')) flayer=l;
    });

    // Fallback: create from URL
    if(!flayer){
      flayer = new FeatureLayer({
        url:SVC, outFields:['*'],
        popupEnabled:false
      });
    }

    // Click → filter by sector + zoom
    mapView.on('click', async evt=>{
      const res = await mapView.hitTest(evt,{include:flayer||wm.layers});
      const hit  = res.results[0];
      if(!hit){ hideMapInfo(); return; }
      const a = hit.graphic.attributes;
      const sector = a[F.sector]||'';
      const zone   = a[F.zone]||'';
      const status = a[F.status]||'';

      if(sector){
        filters.sector = sector;
        $('selS').value = sector;
        $('selS').classList.add('on');
        $('clrS').classList.add('on');
        $('mapChip').classList.add('hide');
        $('mapInfo').style.display='block';
        $('miName').textContent = sector;
        $('miDetail').textContent = `Zone: ${zone||'—'} · ${status||'—'}`;
        zoomToSector(sector);
        loadData();
      }
    });

    loadFilters().then(()=>loadData());
  });

  // expose
  window._zoomToSector = async function(name){
    if(!flayer || !mapView) return;
    try{
      const q = {where:`${F.sector}='${name.replace(/'/g,"''")}'`,returnGeometry:true,outSpatialReference:mapView.spatialReference};
      const res = flayer.queryExtent ? await flayer.queryExtent(q) : null;
      if(res?.extent) mapView.goTo(res.extent.expand(1.4),{duration:700,easing:'ease-in-out'});
    }catch(e){ console.warn('zoom err',e); }
  };

  window._applyDefExp = function(where){
    const expr = where==='1=1' ? '' : where;
    if(flayer) flayer.definitionExpression = expr;
    wm.layers.forEach(l=>{ if(l.definitionExpression!==undefined) l.definitionExpression=expr; });
  };
});

function zoomToSector(s){ if(window._zoomToSector) _zoomToSector(s); }
function applyDef(w){ if(window._applyDefExp) _applyDefExp(w); }
function hideMapInfo(){ $('mapInfo').style.display='none'; $('mapChip').classList.remove('hide'); }

// ══════════════════════════════════════════════════
// FILTER INIT
// ══════════════════════════════════════════════════
async function loadFilters(){
  setOv('Loading filter options…');
  const [sectors,cells,villages,zones] = await Promise.all([
    qDistinct(F.sector), qDistinct(F.cell), qDistinct(F.village), qDistinct(F.zone)
  ]);
  populateSel('selS',sectors,'All Sectors');
  populateSel('selC',cells,'All Cells');
  populateSel('selV',villages,'All Villages');
  buildZoneChips(zones);
}

function populateSel(id,vals,ph){
  const s=$(''+id);
  s.innerHTML=`<option value="">${ph}</option>`;
  vals.forEach(v=>{ const o=document.createElement('option'); o.value=o.textContent=v; s.appendChild(o); });
}

function buildZoneChips(zones){
  $('zoneGrid').innerHTML = zones.map(z=>{
    const c  = ZONE_COLORS[z]||'#94a3b8';
    const tc = isLight(z) ? '#0b1320' : '#fff';
    return `<button class="zc" data-z="${z}" style="background:${c};color:${tc}"
      onclick="onZoneClick('${z}')" title="${ZONE_NAMES[z]||z}">${z}</button>`;
  }).join('');
}

// ══════════════════════════════════════════════════
// FILTER ACTIONS
// ══════════════════════════════════════════════════
function onF(type,val){
  filters[type]=val;
  const IDS={sector:['selS','clrS'],cell:['selC','clrC'],village:['selV','clrV']};
  const [sId,cId]=IDS[type];
  $(sId).classList.toggle('on',!!val);
  $(cId).classList.toggle('on',!!val);
  if(type==='sector' && val) zoomToSector(val);
  loadData();
}

function onZoneClick(z){
  filters.zone = filters.zone===z ? '' : z;
  document.querySelectorAll('.zc').forEach(b=>b.classList.toggle('on',b.dataset.z===filters.zone));
  $('clrZ').classList.toggle('on',!!filters.zone);
  loadData();
}

function clearF(type){
  filters[type]='';
  if(type==='sector'){  $('selS').value=''; $('selS').classList.remove('on'); $('clrS').classList.remove('on'); hideMapInfo(); }
  if(type==='cell'){    $('selC').value=''; $('selC').classList.remove('on'); $('clrC').classList.remove('on'); }
  if(type==='village'){ $('selV').value=''; $('selV').classList.remove('on'); $('clrV').classList.remove('on'); }
  if(type==='zone'){
    document.querySelectorAll('.zc').forEach(b=>b.classList.remove('on'));
    $('clrZ').classList.remove('on');
  }
  loadData();
}

function clearAll(){
  filters={sector:'',cell:'',village:'',zone:''};
  ['selS','selC','selV'].forEach(id=>{ $(id).value=''; $(id).classList.remove('on'); });
  ['clrS','clrC','clrV','clrZ'].forEach(id=>$(id).classList.remove('on'));
  document.querySelectorAll('.zc').forEach(b=>b.classList.remove('on'));
  $('actTags').innerHTML='';
  hideMapInfo();
  applyDef('1=1');
  loadData();
}

function renderTags(){
  const tags=[];
  if(filters.sector)  tags.push({k:'sector', l:'Sector: '+filters.sector});
  if(filters.cell)    tags.push({k:'cell',   l:'Cell: '+filters.cell});
  if(filters.village) tags.push({k:'village',l:'Village: '+filters.village});
  if(filters.zone)    tags.push({k:'zone',   l:'Zone: '+filters.zone});
  $('actTags').innerHTML = tags.map(t=>
    `<span class="tag">${t.l}<button onclick="clearF('${t.k}')"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg></button></span>`
  ).join('');
}

// ══════════════════════════════════════════════════
// DATA LOAD
// ══════════════════════════════════════════════════
async function loadData(){
  const where = buildWhere();
  applyDef(where);
  renderTags();
  setOv('Loading data…');

  try{
    const [statusRows, zoneRows, sZoneRows] = await Promise.all([
      qStats(where, F.status),
      qStats(where, F.zone),
      qStats(where, `${F.sector},${F.zone},${F.status}`)
    ]);

    let total=0,legal=0,illegal=0,existing=0;
    statusRows.forEach(f=>{
      const v=(f.attributes[F.status]||'').toLowerCase();
      const c=f.attributes.cnt;
      total+=c;
      if(v===STATUS.legal.toLowerCase())    legal+=c;
      else if(v===STATUS.illegal.toLowerCase()) illegal+=c;
      else existing+=c;
    });

    renderTopbar(total,legal,existing);
    renderKPIs(total,legal,illegal,existing);
    renderZoneBars(zoneRows,total);
    renderTable(sZoneRows);
    setOv(null);
  }catch(e){
    $('ovTxt').innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" style="vertical-align:-3px;margin-right:6px"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'+e.message;
    console.error(e);
  }
}

async function refresh(){
  const btn=$('rfBtn');
  btn.classList.add('spin');
  await loadData().catch(()=>{});
  btn.classList.remove('spin');
}

// ══ RENDER
function renderTopbar(total,legal,existing){
  $('hTotal').textContent=fmt(total);
  $('hLegal').textContent=fmt(legal);
  $('hExist').textContent=fmt(existing);
}

function renderKPIs(total,legal,illegal,existing){
  $('kT').textContent=fmt(total);
  $('kL').textContent=fmt(legal);
  $('kE').textContent=fmt(existing);
  $('kLs').textContent=pct(legal,total)+' of total';
  $('kEs').textContent=pct(existing,total)+' of total';
}

function renderZoneBars(rows,grand){
  const byZ={};
  rows.forEach(f=>{ const z=f.attributes[F.zone]||'?'; byZ[z]=(byZ[z]||0)+f.attributes.cnt; });
  const sorted=Object.entries(byZ).sort((a,b)=>b[1]-a[1]);
  const max=sorted[0]?.[1]||1;
  $('zoneN').textContent=sorted.length+' zones';
  $('zbList').innerHTML=sorted.slice(0,10).map(([code,cnt])=>{
    const c=ZONE_COLORS[code]||'#94a3b8';
    const tc=isLight(code)?'#0b1320':'rgba(255,255,255,.9)';
    const w=(cnt/max*100).toFixed(1);
    return `<div class="zb">
      <div class="zb-code" style="background:${c};color:${tc}" onclick="onZoneClick('${code}')" title="${ZONE_NAMES[code]||code}">${code}</div>
      <div class="zb-track">
        <div class="zb-fill" style="width:${w}%;background:${c}">
          <span style="color:${tc}">${fmt(cnt)}</span>
        </div>
      </div>
      <span class="zb-pct">${pct(cnt,grand)}</span>
    </div>`;
  }).join('');
}

function renderTable(rows){
  // Aggregate: sector + zone → totals
  const agg={};
  rows.forEach(f=>{
    const sec=f.attributes[F.sector]||'Unknown';
    const z=f.attributes[F.zone]||'—';
    const st=(f.attributes[F.status]||'').toLowerCase();
    const cnt=f.attributes.cnt||0;
    const key=`${sec}||${z}`;
    if(!agg[key]) agg[key]={sector:sec,zone:z,total:0,legal:0,illegal:0,existing:0};
    agg[key].total+=cnt;
    if(st===STATUS.legal.toLowerCase())    agg[key].legal+=cnt;
    else if(st===STATUS.illegal.toLowerCase()) agg[key].illegal+=cnt;
    else agg[key].existing+=cnt;
  });

  tableRows=Object.values(agg).sort((a,b)=>b.total-a.total);
  $('tblN').textContent=tableRows.length.toLocaleString()+' rows';

  if(!tableRows.length){
    $('tbl').innerHTML=`<tr><td colspan="5">
      <div class="empty">
        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
        No records match current filters
      </div>
    </td></tr>`;
    return;
  }

  $('tbl').innerHTML = tableRows.map(r=>{
    const c=ZONE_COLORS[r.zone]||'#94a3b8';
    const tc=isLight(r.zone)?'#0b1320':'#fff';
    return `<tr onclick="onRow('${r.sector}','${r.zone}')">
      <td title="${r.sector}">${r.sector}</td>
      <td>${r.zone!=='—'?`<span class="chip" style="background:${c};color:${tc}">${r.zone}</span>`:'—'}</td>
      <td title="${ZONE_NAMES[r.zone]||r.zone}" style="font-size:10px;color:var(--ink3)">${(ZONE_NAMES[r.zone]||r.zone).slice(0,14)}</td>
      <td><span class="cnt">${fmt(r.total)}</span></td>
      <td style="color:var(--green);font-family:var(--mono)">${fmt(r.legal)}</td>
    </tr>`;
  }).join('');
}

function onRow(sector,zone){
  filters.sector=sector;
  $('selS').value=sector;
  $('selS').classList.add('on');
  $('clrS').classList.add('on');
  if(zone&&zone!=='—'){
    filters.zone=zone;
    document.querySelectorAll('.zc').forEach(b=>b.classList.toggle('on',b.dataset.z===zone));
    $('clrZ').classList.add('on');
  }
  zoomToSector(sector);
  loadData();
}

// ══ CSV DOWNLOAD
function downloadCSV(){
  if(!tableRows.length) return;
  const hdr=['Sector','Zone Code','Zone Type','Total Buildings','Legal','Illegal','Existing'];
  const body=tableRows.map(r=>[
    r.sector,r.zone,ZONE_NAMES[r.zone]||r.zone,r.total,r.legal,r.illegal,r.existing
  ]);
  const csv=[hdr,...body].map(row=>row.map(v=>`"${v}"`).join(',')).join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download=`Rubavu_Buildings_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}
</script>
</body>
</html>
